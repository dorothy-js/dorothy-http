/* @pollon/http - v1.0.0
* https://github.com/pollon-js/http#readme
* 2020 Francesco Lasaracina. Licensed ISC */
define(["exports","@pollon/message-broker"],(function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}var a={REQUEST_ISSUED:"pollon.application.requestissued",REQUEST_REJECTED:"pollon.application.requestrejected",REQUEST_RESOLVED:"pollon.application.requestresolved",REQUEST_BLOCKED:"pollon.application.requestblocked",REQUEST_TIMEDOUT:"pollon.application.requesttimedout"},l=function(e){function t(e,r,o){var i;return n(this,t),(i=c(this,u(t).call(this,e))).reason=r,i.args=o,i}return i(t,e),t}(t.Event),f=function(e){function t(e){var r;return n(this,t),(r=c(this,u(t).call(this,a.REQUEST_TIMEDOUT))).request=e,r}return i(t,e),t}(t.Event),E=function(e){function t(e,r){var o;return n(this,t),(o=c(this,u(t).call(this,a.REQUEST_RESOLVED))).request=e,o.response=r,o}return i(t,e),t}(t.Event),h=function(e){function t(e){var r;return n(this,t),(r=c(this,u(t).call(this,a.REQUEST_ISSUED))).request=e,r}return i(t,e),t}(t.Event),p={method:"GET",headers:{},credentials:"omit"},T=function(){function e(r){n(this,e),this.publisher=new t.Publisher(Object.values(a)),this.requestFilters=[],r.Bus.add(this.publisher)}return o(e,[{key:"EVENTS",get:function(){return a}}]),o(e,[{key:"addStatusCheck",value:function(e){this.requestFilters.push(e)}},{key:"checkStatus",value:function(e){return Array.isArray(this.requestFilters)?(t=this.requestFilters.map((function(e){return e instanceof Promise?e:e instanceof Function?e():e})),new Promise((function(n,r){Promise.all(t).then((function(e){for(var t=0;t<e.length;t++)e[t]||r();n(e)})).catch((function(t){r("Pollon: [transport:http:checkstatus] cannot execute ".concat(e,". Some filters blocked the request"))}))}))):Promise.reject("Pollon: [transport:http] Invalid Datalayer request filters");var t}},{key:"make",value:function(e,t,n){var r=this;if(!t||!t.url)throw new Error('Pollon: [transport:http:make] cannot make "'.concat(e,'". Configuration is missing or is incorrect.'));var o=Object.assign({},p,{name:e},t||{}),i=!1;return Promise.race([new Promise((function(u,s){var c,f;c=5,f=function(){(n?r.checkStatus(e):Promise.resolve(!0)).then((function(){fetch(t.url,o).then((function(e){u(e),i=!0,r.publisher.fire(a.REQUEST_RESOLVED,new E(o,e))})).catch((function(e){if(--c<=0)return i=!0,e="Pollon: [transport:http:make] Too many retry. ".concat(e),o.rerun=function(){},r.publisher.fire(a.REQUEST_BLOCKED,new l(a.REQUEST_BLOCKED,e,o)),void s(e);r.publisher.fire(a.REQUEST_REJECTED,new l(a.REQUEST_REJECTED,e,o))}))})).catch((function(e){i=!0,r.publisher.fire(a.REQUEST_BLOCKED,new l(a.REQUEST_BLOCKED,e,o)),s(e)}))},o.rerun=f,r.publisher.fire(a.REQUEST_ISSUED,new h(o)),f()})),new Promise((function(e,t){return setTimeout((function(){i||r.publisher.fire(a.REQUEST_TIMEDOUT,new f(a.REQUEST_TIMEDOUT,o))}),5e3)}))])}},{key:"get",value:function(e,t){return t.method="GET",this.make(e,t)}},{key:"post",value:function(e,t){return t.method="POST",this.make(e,t)}}]),e}(),S={install:function(e,t){e.Http=new T(e)}};e.Http=S,Object.defineProperty(e,"__esModule",{value:!0})}));
