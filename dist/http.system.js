/* @pollon/http - v1.0.0
* https://github.com/pollon-js/http#readme
* 2020 Francesco Lasaracina. Licensed ISC */
System.register(["@pollon/message-broker"],(function(t){"use strict";var e,n;return{setters:[function(t){e=t.Event,n=t.Publisher}],execute:function(){function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function i(t,e,n){return e&&o(t.prototype,e),n&&o(t,n),t}function u(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&s(t,e)}function c(t){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function s(t,e){return(s=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function a(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function l(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=c(t);if(e){var o=c(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return a(this,n)}}var f={REQUEST_ISSUED:"pollon.application.requestissued",REQUEST_REJECTED:"pollon.application.requestrejected",REQUEST_RESOLVED:"pollon.application.requestresolved",REQUEST_BLOCKED:"pollon.application.requestblocked",REQUEST_TIMEDOUT:"pollon.application.requesttimedout"},E=function(t){u(n,t);var e=l(n);function n(t,o,i){var u;return r(this,n),(u=e.call(this,t)).reason=o,u.args=i,u}return n}(e),p=function(t){u(n,t);var e=l(n);function n(t){var o;return r(this,n),(o=e.call(this,f.REQUEST_TIMEDOUT)).request=t,o}return n}(e),h=function(t){u(n,t);var e=l(n);function n(t,o){var i;return r(this,n),(i=e.call(this,f.REQUEST_RESOLVED)).request=t,i.response=o,i}return n}(e),T=function(t){u(n,t);var e=l(n);function n(t){var o;return r(this,n),(o=e.call(this,f.REQUEST_ISSUED)).request=t,o}return n}(e),S={method:"GET",headers:{},credentials:"omit"},v=function(){function t(e){r(this,t),this.publisher=new n(Object.values(f)),this.requestFilters=[],e.Bus.add(this.publisher)}return i(t,[{key:"EVENTS",get:function(){return f}}]),i(t,[{key:"addStatusCheck",value:function(t){this.requestFilters.push(t)}},{key:"checkStatus",value:function(t){return Array.isArray(this.requestFilters)?(e=this.requestFilters.map((function(t){return t instanceof Promise?t:t instanceof Function?t():t})),new Promise((function(n,r){Promise.all(e).then((function(t){for(var e=0;e<t.length;e++)t[e]||r();n(t)})).catch((function(e){r("Pollon: [transport:http:checkstatus] cannot execute ".concat(t,". Some filters blocked the request"))}))}))):Promise.reject("Pollon: [transport:http] Invalid Datalayer request filters");var e}},{key:"make",value:function(t,e,n){var r=this;if(!e||!e.url)throw new Error('Pollon: [transport:http:make] cannot make "'.concat(t,'". Configuration is missing or is incorrect.'));var o=Object.assign({},S,{name:t},e||{}),i=!1;return Promise.race([new Promise((function(u,c){var s,a;s=5,a=function(){(n?r.checkStatus(t):Promise.resolve(!0)).then((function(){fetch(e.url,o).then((function(t){u(t),i=!0,r.publisher.fire(f.REQUEST_RESOLVED,new h(o,t))})).catch((function(t){if(--s<=0)return i=!0,t="Pollon: [transport:http:make] Too many retry. ".concat(t),o.rerun=function(){},r.publisher.fire(f.REQUEST_BLOCKED,new E(f.REQUEST_BLOCKED,t,o)),void c(t);r.publisher.fire(f.REQUEST_REJECTED,new E(f.REQUEST_REJECTED,t,o))}))})).catch((function(t){i=!0,r.publisher.fire(f.REQUEST_BLOCKED,new E(f.REQUEST_BLOCKED,t,o)),c(t)}))},o.rerun=a,r.publisher.fire(f.REQUEST_ISSUED,new T(o)),a()})),new Promise((function(t,e){return setTimeout((function(){i||r.publisher.fire(f.REQUEST_TIMEDOUT,new p(f.REQUEST_TIMEDOUT,o))}),5e3)}))])}},{key:"get",value:function(t,e){return e.method="GET",this.make(t,e)}},{key:"post",value:function(t,e){return e.method="POST",this.make(t,e)}}]),t}();t("Http",{install:function(t,e){t.Http=new v(t)}})}}}));
